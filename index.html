<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片消消乐 - 可自定义与分享</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        game: ['"Comic Sans MS"', '"Marker Felt"', 'cursive', 'sans-serif']
                    },
                    animation: {
                        'pop': 'pop 0.3s ease-out',
                        'disappear': 'disappear 0.4s ease-in-out',
                        'fall': 'fall 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'slide-in': 'slideIn 0.5s ease-out'
                    },
                    keyframes: {
                        pop: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.1)' }
                        },
                        disappear: {
                            '0%': { transform: 'scale(1)', opacity: 1 },
                            '50%': { transform: 'scale(1.2)', opacity: 0.8 },
                            '100%': { transform: 'scale(0)', opacity: 0 }
                        },
                        fall: {
                            '0%': { transform: 'translateY(-100%)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-20px)', opacity: 0 },
                            '100%': { transform: 'translateX(0)', opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .tile-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .tile-selected {
                @apply ring-4 ring-accent scale-105 transition-all duration-200;
            }
            .glass-effect {
                @apply bg-white/70 backdrop-blur-md;
            }
            .btn-hover {
                @apply transform hover:scale-105 transition-all duration-200 hover:shadow-lg;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen font-game text-dark">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- 页面标题 -->
        <header class="text-center mb-6 animate-slide-in">
            <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-primary mb-2 flex items-center justify-center">
                <i class="fa fa-th-large mr-3 animate-pulse"></i>图片消消乐
            </h1>
            <p class="text-gray-600 max-w-md mx-auto">自定义图片，设置时间，生成短链接邀请好友一起玩</p>
        </header>
        
        <!-- 游戏状态显示 -->
        <div class="flex flex-wrap justify-center gap-3 md:gap-6 mb-6">
            <div class="glass-effect rounded-xl shadow-md px-4 py-2 md:px-6 md:py-3 flex items-center">
                <i class="fa fa-star text-accent text-xl mr-2"></i>
                <span class="font-bold">分数:</span>
                <span id="score" class="ml-2 text-xl font-bold text-primary">0</span>
            </div>
            
            <div class="glass-effect rounded-xl shadow-md px-4 py-2 md:px-6 md:py-3 flex items-center">
                <i class="fa fa-clock-o text-secondary text-xl mr-2"></i>
                <span class="font-bold">剩余时间:</span>
                <span id="time" class="ml-2 text-xl font-bold text-primary">60</span>
                <span class="ml-1">秒</span>
            </div>
            
            <button id="resetBtn" class="bg-primary hover:bg-primary/90 text-white rounded-xl shadow-md px-4 py-2 md:px-6 md:py-3 flex items-center btn-hover">
                <i class="fa fa-refresh mr-2"></i>重新开始
            </button>
            
            <button id="shareBtn" class="bg-accent hover:bg-accent/90 text-white rounded-xl shadow-md px-4 py-2 md:px-6 md:py-3 flex items-center btn-hover hidden">
                <i class="fa fa-share-alt mr-2"></i>分享游戏
            </button>
        </div>
        
        <!-- 主要游戏区域 -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- 游戏棋盘 -->
            <div class="flex-1 glass-effect rounded-2xl shadow-lg p-3 md:p-5">
                <div id="gameBoard" class="grid grid-cols-6 gap-1 md:gap-2 aspect-square max-w-md mx-auto">
                    <!-- 游戏方块将通过JS动态生成 -->
                </div>
            </div>
            
            <!-- 侧边面板 -->
            <div class="w-full lg:w-80">
                <!-- 图片设置面板 -->
                <div id="imageSetupPanel" class="glass-effect rounded-2xl shadow-lg p-5 mb-6">
                    <h2 class="text-xl font-bold text-primary mb-4 flex items-center">
                        <i class="fa fa-picture-o mr-2"></i>游戏设置
                    </h2>
                    
                    <div id="imageLockedNotice" class="hidden p-3 bg-amber-50 border border-amber-200 rounded-lg mb-4 text-sm text-amber-800">
                        <i class="fa fa-info-circle mr-1"></i> 图片已设置，<strong>重新开始</strong>后可更换
                    </div>
                    
                    <!-- 时间设置 -->
                    <div class="space-y-2 mb-6">
                        <label class="block text-gray-700 text-sm font-medium">游戏时间（秒）</label>
                        <input type="range" id="timeSetting" min="30" max="300" step="10" value="60" 
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>30秒</span>
                            <span id="timeValue">60秒</span>
                            <span>300秒</span>
                        </div>
                    </div>
                    
                    <!-- 图片上传区域 -->
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="block text-gray-700 text-sm font-medium">图片1</label>
                            <div class="flex gap-2">
                                <input type="file" id="img1" accept="image/*" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <img id="preview1" src="https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_b.jpeg" alt="图片1预览" class="w-14 h-14 object-cover rounded-lg border border-gray-200 shadow-sm">
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-gray-700 text-sm font-medium">图片2</label>
                            <div class="flex gap-2">
                                <input type="file" id="img2" accept="image/*" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <img id="preview2" src="https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_c.jpeg" alt="图片2预览" class="w-14 h-14 object-cover rounded-lg border border-gray-200 shadow-sm">
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-gray-700 text-sm font-medium">图片3</label>
                            <div class="flex gap-2">
                                <input type="file" id="img3" accept="image/*" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <img id="preview3" src="https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_d.jpeg" alt="图片3预览" class="w-14 h-14 object-cover rounded-lg border border-gray-200 shadow-sm">
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-gray-700 text-sm font-medium">图片4</label>
                            <div class="flex gap-2">
                                <input type="file" id="img4" accept="image/*" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <img id="preview4" src="https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_a.jpeg" alt="图片4预览" class="w-14 h-14 object-cover rounded-lg border border-gray-200 shadow-sm">
                            </div>
                        </div>
                        
                        <button id="resetImagesBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white rounded-lg py-2.5 font-medium transition-all mb-3 btn-hover">
                            <i class="fa fa-undo mr-2"></i>重置为默认图片
                        </button>
                        
                        <button id="startGameBtn" class="w-full bg-secondary hover:bg-secondary/90 text-white rounded-lg py-3 font-medium transition-all btn-hover">
                            <i class="fa fa-play mr-2"></i>开始游戏
                        </button>
                    </div>
                </div>
                
                <!-- 游戏规则 -->
                <div class="glass-effect rounded-2xl shadow-lg p-5">
                    <h2 class="text-xl font-bold text-primary mb-4 flex items-center">
                        <i class="fa fa-book mr-2"></i>游戏规则
                    </h2>
                    
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>点击并交换相邻图片，3个或以上相同图片连成一线即可消除</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>每消除一个图片得10分，时间结束前争取最高分</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>设置好图片和时间后，可生成链接邀请好友一起玩</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>游戏开始后无法更换图片，需重新开始才能更改</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 分享弹窗 -->
        <div id="shareModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl animate-slide-in">
                <h3 class="text-xl font-bold text-primary mb-3 flex items-center">
                    <i class="fa fa-share-alt mr-2"></i>分享游戏
                </h3>
                
                <p class="text-gray-600 text-sm mb-4">复制链接，好友可使用相同设置玩游戏：</p>
                
                <div class="flex mb-5">
                    <input type="text" id="shareLink" class="flex-1 border border-gray-300 rounded-l-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" readonly>
                    <button id="copyLinkBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-2 rounded-r-lg transition-all btn-hover">
                        <i class="fa fa-copy"></i>
                    </button>
                </div>
                
                <div class="flex justify-center gap-4 mb-4">
                    <button class="text-blue-600 hover:text-blue-800 transition-colors">
                        <i class="fa fa-weixin text-2xl"></i>
                    </button>
                    <button class="text-blue-400 hover:text-blue-600 transition-colors">
                        <i class="fa fa-qq text-2xl"></i>
                    </button>
                    <button class="text-green-500 hover:text-green-700 transition-colors">
                        <i class="fa fa-weibo text-2xl"></i>
                    </button>
                </div>
                
                <button id="closeShareBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg py-2.5 font-medium transition-all btn-hover">
                    关闭
                </button>
            </div>
        </div>
        
        <!-- 游戏结束弹窗 -->
        <div id="gameOverModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl animate-slide-in">
                <h2 class="text-2xl font-bold text-primary mb-2 text-center">游戏结束!</h2>
                <p class="text-gray-600 mb-3 text-center">你的最终得分</p>
                <p id="finalScore" class="text-5xl font-bold text-accent mb-5 text-center animate-pop">0</p>
                
                <button id="shareAfterGameBtn" class="w-full bg-accent hover:bg-accent/90 text-white rounded-lg py-3 font-medium transition-all mb-3 btn-hover">
                    <i class="fa fa-share-alt mr-2"></i>分享我的成绩
                </button>
                
                <button id="playAgainBtn" class="w-full bg-primary hover:bg-primary/90 text-white rounded-lg py-3 font-medium transition-all btn-hover">
                    再玩一次
                </button>
                
                <button id="restartWithNewSettingsBtn" class="w-full mt-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg py-2.5 font-medium transition-all btn-hover">
                    <i class="fa fa-cog mr-2"></i>重新设置并开始
                </button>
            </div>
        </div>
    </div>

    <script>
        // 游戏配置
        const CONFIG = {
            gridSize: 6,        // 6x6网格
            tileTypes: 4,       // 图片类型数量
            defaultTimeLimit: 60, // 默认时间限制(秒)
            minTimeLimit: 30,   // 最小时间限制(秒)
            maxTimeLimit: 300,  // 最大时间限制(秒)
            timeStep: 10,       // 时间调整步长(秒)
            pointsPerTile: 10,  // 每个方块的分数
            shortCodeLength: 8  // 短代码长度
        };
        
        // 游戏状态
        const game = {
            grid: [],           // 游戏网格数据
            score: 0,           // 当前分数
            timeLimit: CONFIG.defaultTimeLimit, // 时间限制
            timeLeft: CONFIG.defaultTimeLimit,  // 剩余时间
            isProcessing: false,// 是否正在处理动画
            isPlaying: false,   // 是否正在游戏中
            selectedTile: null, // 选中的方块
            timer: null,        // 计时器
            // 默认图片 - 使用更新后的直接图片链接
            defaultImages: [
                "https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_b.jpeg",
                "https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_c.jpeg",
                "https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_d.jpeg",
                "https://images.cnblogs.com/cnblogs_com/mengzhongjue/2470445/o_250812015826_a.jpeg"
            ],
            currentImages: [],  // 当前使用的图片
            imagesLocked: false,// 图片是否已锁定（游戏开始后不能更换）
            gameId: null,       // 游戏唯一标识符
            shareUrl: ""        // 分享链接
        };
        
        // DOM元素
        const elements = {
            gameBoard: document.getElementById('gameBoard'),
            scoreDisplay: document.getElementById('score'),
            timeDisplay: document.getElementById('time'),
            resetBtn: document.getElementById('resetBtn'),
            shareBtn: document.getElementById('shareBtn'),
            startGameBtn: document.getElementById('startGameBtn'),
            resetImagesBtn: document.getElementById('resetImagesBtn'),
            imageSetupPanel: document.getElementById('imageSetupPanel'),
            imageLockedNotice: document.getElementById('imageLockedNotice'),
            gameOverModal: document.getElementById('gameOverModal'),
            finalScoreDisplay: document.getElementById('finalScore'),
            playAgainBtn: document.getElementById('playAgainBtn'),
            restartWithNewSettingsBtn: document.getElementById('restartWithNewSettingsBtn'),
            shareAfterGameBtn: document.getElementById('shareAfterGameBtn'),
            shareModal: document.getElementById('shareModal'),
            shareLink: document.getElementById('shareLink'),
            copyLinkBtn: document.getElementById('copyLinkBtn'),
            closeShareBtn: document.getElementById('closeShareBtn'),
            timeSetting: document.getElementById('timeSetting'),
            timeValue: document.getElementById('timeValue'),
            // 图片预览和输入
            previews: [
                document.getElementById('preview1'),
                document.getElementById('preview2'),
                document.getElementById('preview3'),
                document.getElementById('preview4')
            ],
            imageInputs: [
                document.getElementById('img1'),
                document.getElementById('img2'),
                document.getElementById('img3'),
                document.getElementById('img4')
            ]
        };
        
        // 初始化游戏
        function initGame() {
            // 初始化图片
            game.currentImages = [...game.defaultImages];
            
            // 从URL参数加载游戏配置
            loadGameFromUrl();
            
            // 重置游戏状态
            game.grid = createGrid();
            game.score = 0;
            game.timeLeft = game.timeLimit;
            game.isProcessing = false;
            game.isPlaying = false;
            game.selectedTile = null;
            game.imagesLocked = false;
            
            // 更新显示
            elements.scoreDisplay.textContent = '0';
            elements.timeDisplay.textContent = game.timeLeft;
            elements.timeSetting.value = game.timeLimit;
            elements.timeValue.textContent = `${game.timeLimit}秒`;
            
            // 渲染游戏板
            renderGrid();
            
            // 清除现有计时器
            if (game.timer) clearInterval(game.timer);
            
            // 更新UI状态
            updateUiState();
        }
        
        // 从URL参数加载游戏配置
        function loadGameFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const gameCode = params.get('g');
            
            if (gameCode) {
                try {
                    // 解码游戏配置
                    const decoded = atob(gameCode);
                    const config = JSON.parse(decoded);
                    
                    // 验证配置
                    if (config.images && config.images.length === CONFIG.tileTypes && 
                        config.timeLimit >= CONFIG.minTimeLimit && 
                        config.timeLimit <= CONFIG.maxTimeLimit) {
                        
                        game.currentImages = config.images;
                        game.timeLimit = config.timeLimit;
                        
                        // 更新预览图
                        game.currentImages.forEach((img, index) => {
                            if (elements.previews[index]) {
                                elements.previews[index].src = img;
                            }
                        });
                    }
                } catch (e) {
                    console.error('Failed to load game config from URL', e);
                }
            }
        }
        
        // 生成游戏分享代码
        function generateGameCode() {
            const config = {
                images: game.currentImages,
                timeLimit: game.timeLimit
            };
            
            // 编码配置为Base64
            return btoa(JSON.stringify(config));
        }
        
        // 生成分享链接
        function generateShareLink() {
            const gameCode = generateGameCode();
            const baseUrl = window.location.origin + window.location.pathname;
            game.shareUrl = `${baseUrl}?g=${gameCode}`;
            elements.shareLink.value = game.shareUrl;
        }
        
        // 创建游戏网格
        function createGrid() {
            const grid = [];
            
            for (let row = 0; row < CONFIG.gridSize; row++) {
                grid[row] = [];
                for (let col = 0; col < CONFIG.gridSize; col++) {
                    // 确保不会初始就有可消除的组合
                    let type;
                    do {
                        type = Math.floor(Math.random() * CONFIG.tileTypes);
                    } while (checkInitialMatch(row, col, type, grid));
                    
                    grid[row][col] = type;
                }
            }
            
            return grid;
        }
        
        // 检查初始状态是否会形成匹配
        function checkInitialMatch(row, col, type, grid) {
            // 检查水平方向
            if (col >= 2 && 
                grid[row][col-1] === type && 
                grid[row][col-2] === type) {
                return true;
            }
            
            // 检查垂直方向
            if (row >= 2 && 
                grid[row-1][col] === type && 
                grid[row-2][col] === type) {
                return true;
            }
            
            return false;
        }
        
        // 渲染游戏网格
        function renderGrid() {
            elements.gameBoard.innerHTML = '';
            
            for (let row = 0; row < CONFIG.gridSize; row++) {
                for (let col = 0; col < CONFIG.gridSize; col++) {
                    const tile = document.createElement('div');
                    const type = game.grid[row][col];
                    
                    tile.className = 'rounded-md overflow-hidden cursor-pointer flex items-center justify-center tile-shadow transition-all duration-200';
                    tile.dataset.row = row;
                    tile.dataset.col = col;
                    
                    // 添加图片
                    const img = document.createElement('img');
                    img.src = game.currentImages[type];
                    img.alt = `游戏图片 ${type + 1}`;
                    img.className = 'w-full h-full object-cover transition-all duration-200';
                    
                    // 如果是选中的方块，添加选中样式
                    if (game.selectedTile && 
                        game.selectedTile.row === row && 
                        game.selectedTile.col === col) {
                        tile.classList.add('tile-selected');
                    }
                    
                    tile.appendChild(img);
                    
                    // 添加点击事件
                    tile.addEventListener('click', () => handleTileClick(row, col));
                    
                    // 添加悬停效果
                    tile.addEventListener('mouseenter', () => {
                        if (!game.isProcessing && !game.selectedTile && game.isPlaying) {
                            tile.classList.add('scale-105', 'shadow-md');
                        }
                    });
                    
                    tile.addEventListener('mouseleave', () => {
                        if (!game.isProcessing && !game.selectedTile && game.isPlaying) {
                            tile.classList.remove('scale-105', 'shadow-md');
                        }
                    });
                    
                    elements.gameBoard.appendChild(tile);
                }
            }
        }
        
        // 处理方块点击
        function handleTileClick(row, col) {
            // 如果正在处理动画或未在游戏中，则不响应点击
            if (game.isProcessing || !game.isPlaying) return;
            
            // 如果没有选中的方块，选中当前方块
            if (!game.selectedTile) {
                game.selectedTile = { row, col };
                renderGrid(); // 重新渲染以显示选中状态
                return;
            }
            
            // 如果点击的是已选中的方块，取消选中
            if (game.selectedTile.row === row && game.selectedTile.col === col) {
                game.selectedTile = null;
                renderGrid();
                return;
            }
            
            // 检查是否相邻
            if (isAdjacent(game.selectedTile, { row, col })) {
                // 交换方块
                swapTiles(game.selectedTile, { row, col });
            } else {
                // 取消之前的选中，选中新方块
                game.selectedTile = { row, col };
                renderGrid();
            }
        }
        
        // 检查两个方块是否相邻
        function isAdjacent(tile1, tile2) {
            const rowDiff = Math.abs(tile1.row - tile2.row);
            const colDiff = Math.abs(tile1.col - tile2.col);
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }
        
        // 交换两个方块
        function swapTiles(tile1, tile2) {
            game.isProcessing = true;
            
            // 交换数据
            const temp = game.grid[tile1.row][tile1.col];
            game.grid[tile1.row][tile1.col] = game.grid[tile2.row][tile2.col];
            game.grid[tile2.row][tile2.col] = temp;
            
            // 更新显示
            renderGrid();
            
            // 添加交换动画效果
            const tiles = [
                document.querySelector(`[data-row="${tile1.row}"][data-col="${tile1.col}"]`),
                document.querySelector(`[data-row="${tile2.row}"][data-col="${tile2.col}"]`)
            ];
            
            tiles.forEach(tile => {
                tile.classList.add('animate-pop');
                setTimeout(() => tile.classList.remove('animate-pop'), 300);
            });
            
            // 检查是否有匹配
            setTimeout(() => {
                const matches = findAllMatches();
                
                if (matches.length > 0) {
                    // 有匹配，处理消除
                    processMatches(matches);
                } else {
                    // 没有匹配，交换回来
                    const temp = game.grid[tile1.row][tile1.col];
                    game.grid[tile1.row][tile1.col] = game.grid[tile2.row][tile2.col];
                    game.grid[tile2.row][tile2.col] = temp;
                    
                    // 更新显示
                    renderGrid();
                    game.isProcessing = false;
                }
                
                // 重置选中状态
                game.selectedTile = null;
            }, 400);
        }
        
        // 查找所有匹配
        function findAllMatches() {
            const matches = [];
            
            // 检查水平匹配
            for (let row = 0; row < CONFIG.gridSize; row++) {
                let col = 0;
                while (col < CONFIG.gridSize - 2) {
                    const currentType = game.grid[row][col];
                    if (currentType === game.grid[row][col + 1] && 
                        currentType === game.grid[row][col + 2]) {
                        // 找到匹配，记录所有连续的方块
                        let matchLength = 3;
                        let currentCol = col + 3;
                        
                        while (currentCol < CONFIG.gridSize && 
                               game.grid[row][currentCol] === currentType) {
                            matchLength++;
                            currentCol++;
                        }
                        
                        // 添加匹配到列表
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row, col: col + i });
                        }
                        
                        col = currentCol;
                    } else {
                        col++;
                    }
                }
            }
            
            // 检查垂直匹配
            for (let col = 0; col < CONFIG.gridSize; col++) {
                let row = 0;
                while (row < CONFIG.gridSize - 2) {
                    const currentType = game.grid[row][col];
                    if (currentType === game.grid[row + 1][col] && 
                        currentType === game.grid[row + 2][col]) {
                        // 找到匹配，记录所有连续的方块
                        let matchLength = 3;
                        let currentRow = row + 3;
                        
                        while (currentRow < CONFIG.gridSize && 
                               game.grid[currentRow][col] === currentType) {
                            matchLength++;
                            currentRow++;
                        }
                        
                        // 添加匹配到列表
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row: row + i, col });
                        }
                        
                        row = currentRow;
                    } else {
                        row++;
                    }
                }
            }
            
            return matches;
        }
        
        // 处理匹配
        function processMatches(matches) {
            if (matches.length === 0) {
                game.isProcessing = false;
                return;
            }
            
            // 计算得分
            game.score += matches.length * CONFIG.pointsPerTile;
            elements.scoreDisplay.textContent = game.score;
            
            // 标记匹配的方块并添加消除动画
            matches.forEach(({ row, col }) => {
                const tile = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                tile.classList.add('animate-disappear');
            });
            
            // 等待动画完成后移除匹配的方块
            setTimeout(() => {
                // 移除匹配的方块（设为null）
                matches.forEach(({ row, col }) => {
                    game.grid[row][col] = null;
                });
                
                // 下落动画
                dropTiles();
            }, 400);
        }
        
        // 处理方块下落
        function dropTiles() {
            // 对每一列处理下落
            for (let col = 0; col < CONFIG.gridSize; col++) {
                // 下落现有方块
                for (let row = CONFIG.gridSize - 1; row > 0; row--) {
                    if (game.grid[row][col] === null) {
                        // 查找上方第一个非空方块
                        for (let aboveRow = row - 1; aboveRow >= 0; aboveRow--) {
                            if (game.grid[aboveRow][col] !== null) {
                                // 移动方块
                                game.grid[row][col] = game.grid[aboveRow][col];
                                game.grid[aboveRow][col] = null;
                                break;
                            }
                        }
                    }
                }
                
                // 顶部补充新方块
                for (let row = 0; row < CONFIG.gridSize; row++) {
                    if (game.grid[row][col] === null) {
                        game.grid[row][col] = Math.floor(Math.random() * CONFIG.tileTypes);
                    }
                }
            }
            
            // 更新显示
            renderGrid();
            
            // 为新出现的方块添加下落动画
            const tiles = elements.gameBoard.querySelectorAll('div');
            tiles.forEach(tile => {
                tile.classList.add('animate-fall');
                setTimeout(() => tile.classList.remove('animate-fall'), 500);
            });
            
            // 检查是否有新的匹配
            setTimeout(() => {
                const newMatches = findAllMatches();
                if (newMatches.length > 0) {
                    processMatches(newMatches);
                } else {
                    game.isProcessing = false;
                }
            }, 600);
        }
        
        // 开始游戏
        function startGame() {
            // 锁定图片设置
            game.imagesLocked = true;
            
            // 更新游戏状态
            game.isPlaying = true;
            game.score = 0;
            game.timeLeft = game.timeLimit;
            game.grid = createGrid();
            
            // 更新显示
            elements.scoreDisplay.textContent = '0';
            elements.timeDisplay.textContent = game.timeLeft;
            renderGrid();
            
            // 启动计时器
            startTimer();
            
            // 更新UI状态
            updateUiState();
            
            // 生成分享链接
            generateShareLink();
        }
        
        // 启动计时器
        function startTimer() {
            // 清除现有计时器
            if (game.timer) clearInterval(game.timer);
            
            game.timer = setInterval(() => {
                game.timeLeft--;
                elements.timeDisplay.textContent = game.timeLeft;
                
                // 改变时间颜色提醒
                if (game.timeLeft <= 10) {
                    elements.timeDisplay.classList.add('text-red-500');
                } else {
                    elements.timeDisplay.classList.remove('text-red-500');
                }
                
                if (game.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }
        
        // 结束游戏
        function endGame() {
            clearInterval(game.timer);
            game.isPlaying = false;
            game.isProcessing = true;
            
            // 显示游戏结束弹窗
            elements.finalScoreDisplay.textContent = game.score;
            elements.gameOverModal.classList.remove('hidden');
            
            // 更新UI状态
            updateUiState();
        }
        
        // 重置图片为默认值
        function resetImages() {
            if (game.imagesLocked) {
                showToast('请先重新开始游戏才能重置图片');
                return;
            }
            
            game.currentImages = [...game.defaultImages];
            
            // 更新预览图
            game.currentImages.forEach((img, index) => {
                if (elements.previews[index]) {
                    elements.previews[index].src = img;
                }
            });
            
            showToast('图片已重置为默认值');
        }
        
        // 设置图片上传预览
        function setupImageUploads() {
            elements.imageInputs.forEach((input, index) => {
                input.addEventListener('change', (e) => {
                    if (game.imagesLocked) {
                        showToast('游戏已开始，无法更换图片');
                        // 清除选择
                        e.target.value = '';
                        return;
                    }
                    
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            // 更新预览图
                            elements.previews[index].src = event.target.result;
                            // 更新当前图片
                            game.currentImages[index] = event.target.result;
                        };
                        
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
            });
        }
        
        // 设置时间选择器
        function setupTimeSelector() {
            elements.timeSetting.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                elements.timeValue.textContent = `${value}秒`;
                
                // 如果游戏未开始，更新时间限制
                if (!game.isPlaying) {
                    game.timeLimit = value;
                    game.timeLeft = value;
                    elements.timeDisplay.textContent = value;
                }
            });
        }
        
        // 更新UI状态
        function updateUiState() {
            // 控制图片上传控件是否可用
            elements.imageInputs.forEach(input => {
                input.disabled = game.imagesLocked;
                if (game.imagesLocked) {
                    input.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    input.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
            
            // 显示/隐藏图片锁定提示
            if (game.imagesLocked) {
                elements.imageLockedNotice.classList.remove('hidden');
            } else {
                elements.imageLockedNotice.classList.remove('hidden');
                elements.imageLockedNotice.classList.add('hidden');
            }
            
            // 控制分享按钮显示
            if (game.isPlaying) {
                elements.shareBtn.classList.remove('hidden');
            } else {
                elements.shareBtn.classList.add('hidden');
            }
            
            // 控制开始游戏按钮状态
            if (game.isPlaying) {
                elements.startGameBtn.disabled = true;
                elements.startGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                elements.startGameBtn.disabled = false;
                elements.startGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            // 创建toast元素
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-dark text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 3秒后移除
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // 事件监听
        elements.resetBtn.addEventListener('click', () => {
            // 确认重置
            if (game.isPlaying && confirm('确定要重新开始游戏吗？当前进度将会丢失。')) {
                clearInterval(game.timer);
                initGame();
                showToast('游戏已重置');
            } else if (!game.isPlaying) {
                initGame();
                showToast('游戏已重置');
            }
        });
        
        elements.startGameBtn.addEventListener('click', startGame);
        
        elements.resetImagesBtn.addEventListener('click', resetImages);
        
        elements.playAgainBtn.addEventListener('click', () => {
            elements.gameOverModal.classList.add('hidden');
            // 不改变图片和时间设置，重新开始游戏
            game.isPlaying = true;
            game.score = 0;
            game.timeLeft = game.timeLimit;
            game.grid = createGrid();
            
            elements.scoreDisplay.textContent = '0';
            elements.timeDisplay.textContent = game.timeLeft;
            elements.timeDisplay.classList.remove('text-red-500');
            renderGrid();
            
            startTimer();
            updateUiState();
        });
        
        elements.restartWithNewSettingsBtn.addEventListener('click', () => {
            elements.gameOverModal.classList.add('hidden');
            // 重置游戏，允许更改设置
            initGame();
        });
        
        elements.shareBtn.addEventListener('click', () => {
            generateShareLink();
            elements.shareModal.classList.remove('hidden');
        });
        
        elements.shareAfterGameBtn.addEventListener('click', () => {
            elements.gameOverModal.classList.add('hidden');
            generateShareLink();
            elements.shareModal.classList.remove('hidden');
        });
        
        elements.closeShareBtn.addEventListener('click', () => {
            elements.shareModal.classList.add('hidden');
        });
        
        elements.copyLinkBtn.addEventListener('click', () => {
            elements.shareLink.select();
            document.execCommand('copy');
            
            // 显示复制成功提示
            const originalText = elements.copyLinkBtn.innerHTML;
            elements.copyLinkBtn.innerHTML = '<i class="fa fa-check"></i>';
            showToast('链接已复制');
            
            setTimeout(() => {
                elements.copyLinkBtn.innerHTML = originalText;
            }, 2000);
        });
        
        // 初始化图片上传处理
        setupImageUploads();
        
        // 初始化时间选择器
        setupTimeSelector();
        
        // 启动游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
